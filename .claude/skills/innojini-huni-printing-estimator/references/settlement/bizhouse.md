# 비즈하우스 정산 가이드

## 파일 구조

### 시트 목록 (7개)

| 시트명 | 행수 | 용도 | 중요도 |
|-------|-----|-----|-------|
| **인화업체정산_YYYY-MM-DD** | ~10,530 | 외주사 데이터 | ⭐⭐⭐ |
| **후니내역** | ~10,521 | 내부 MES | ⭐⭐⭐ |
| **중복** | ~11,555 | 매핑 테이블 | ⭐⭐⭐ |
| **보정** | ~66 | 수동 보정 | ⭐⭐ |
| **제주도서** | ~72 | 도서산간 배송비 | ⭐⭐ |
| **0원** | ~10,530 | 0원 처리 참조 | ⭐ |
| **Sheet1** | 1 | 임시/메모 | - |

---

## 핵심 시트 상세

### 1. 인화업체정산 (외주사 데이터)

**주요 컬럼:**
| 컬럼 | 설명 | 예시 |
|-----|-----|-----|
| 상품 IDX | 매칭 Key | 30148381 |
| 주문 IDX | 주문 그룹 | 8360672 |
| 상품명 | 품목 | 접이식 엽서카드 |
| 수량 | 정산 수량 | 1 |
| 총 공급가격 | 정산 금액 | 4070 |
| 배송비 | 배송비 | 3300 |
| 생산단계 | 상태 | 배송완료 |

**생산단계 분포:**
```
배송완료         9,491건 ← 정산 대상
생산다운로드완료   981건
배송출하          57건
포장완료           1건
```

### 2. 후니내역 (내부 MES)

**주요 컬럼:**
| 컬럼 | 설명 | 예시 |
|-----|-----|-----|
| 거래처 제작 or 작업번호 | 매칭 Key | 28476475 |
| 거래처주문번호 | 비즈하우스 주문IDX | 8355048 |
| 품목 명 | 품목 | 2단접지카드 |
| 제작수량 | 내부 수량 | 1 |
| 주문상태 | 상태 | 출고 완료 |

**주문상태 분포:**
```
출고 완료      9,765건 ← 정산 대상
제작 대기       655건
출고 준비 중     93건
고객 취소         8건 ← 제외
```

### 3. 중복 (매핑 테이블)

**컬럼:**
```
상품 IDX, 거래처 제작 or 작업번호, 비고
```

**비고 값 분포:**
```
(빈값)    11,533건 ← 정산 대상
9월정산       16건 ← 이전 정산, 제외
취소           4건 ← 제외
환불           2건 ← 제외
```

---

## 매칭 로직

### 매칭 흐름
```
인화업체정산.상품IDX (예: 30148381)
        ↓
중복시트 조회 (상품IDX → 작업번호)
        ↓
후니내역.작업번호 (예: 28476475)
        ↓
매칭 성공!
```

### Python 코드
```python
def normalize_id(x):
    if pd.isna(x):
        return None
    if isinstance(x, float):
        return str(int(x))
    return str(x)

# 제외 조건
exclude_mask = df_mapping['비고'].isin(['9월정산', '취소', '환불'])

# 매핑 딕셔너리
mapping_dict = {}
for _, row in df_mapping[~exclude_mask].iterrows():
    pid = normalize_id(row['상품IDX'])
    wno = normalize_id(row['작업번호'])
    if pid and wno:
        mapping_dict[pid] = wno
```

---

## 금액 계산

### 공식
```
총 정산금액 = (상품금액 + 배송비 + 제주도서 + 보정) × 1.1

상품금액 = Σ(인화업체정산.총 공급가격)
배송비 = Σ(인화업체정산.배송비)
제주도서 = Σ(제주도서.기타운임)
보정 = Σ(보정.합계금액)
VAT = 소계 × 10%
```

### 결과 예시
```
┌──────────────────────────────────────────┐
│ 상품 공급가격:     ₩226,049,380          │
│ 일반 배송비:       ₩ 24,273,900          │
│ 제주도서 (72건):    ₩    407,000          │
│ 보정 (66건):        ₩ 20,382,990          │
├──────────────────────────────────────────┤
│ 소계:              ₩271,113,270          │
│ VAT (10%):         ₩ 27,111,327          │
├──────────────────────────────────────────┤
│ 총 정산금액:       ₩298,224,597          │
└──────────────────────────────────────────┘
```

---

## 불일치 처리

| 유형 | 원인 | 처리 |
|-----|-----|-----|
| 매핑 없음 | 중복시트 미갱신 | 매핑 추가 |
| 내부 없음 | MES 미등록 | MES 확인 |
| 수량 차이 | 입력 오류 | 양측 확인 |
