# SPEC-WB-003 Acceptance Criteria — Test Results

**SPEC:** SPEC-WB-003: Constraint System — ECA Pattern with json-rules-engine
**Version:** 2.0.0
**Verified:** 2026-02-25
**Status:** PASSED

---

## AC-WB003-01: ECA 제약조건 CRUD

- [x] 8종 action type 모두 생성/수정/삭제 가능
  - Covered by: `src/__tests__/routes/constraints.test.ts` (22 tests)
  - Tests: POST /constraints, PATCH /constraints/:id, DELETE /constraints/:id
- [x] 잘못된 action type 입력 시 422 반환
  - Test: "should return 422 for invalid action type"
- [x] actions 배열 비어있으면 400 반환
  - Test: "should return 400 when actions array is empty"
- [x] priority 순서대로 평가 확인
  - Covered by: ConstraintService sort logic + evaluateConstraints test

## AC-WB003-02: json-rules-engine 런타임 평가

- [x] 고객 옵션 변경 시 평가 엔드포인트 응답
  - Covered by: `src/__tests__/routes/constraintEvaluate.test.ts` (7 tests)
  - Test: POST /api/widget/constraints/evaluate
- [x] exclude_options 발동 시 결과에 포함
  - Test: "should return triggered constraints with actions"
- [x] require_option 발동 시 isValid false 반환
  - Test: "should return isValid false when require_option triggered"
- [x] auto_add 발동 시 actions 배열에 포함
  - Covered by constraint service tests
- [x] change_price_mode 발동 시 actions 배열에 포함
  - Covered by constraint service tests

## AC-WB003-03: 추가상품 그룹

- [x] addon group CRUD 동작 확인
  - Covered by: `src/__tests__/routes/addonGroups.test.ts` (19 tests)
  - Tests: POST, GET, PATCH, DELETE /api/admin/widget/addon-groups
- [x] addon group items 관리 (아이템 추가/삭제)
  - Tests: POST /addon-groups/:id/items, DELETE /addon-groups/:id/items/:itemId
- [x] display_mode (list/checkbox/radio) 저장 확인
  - Test: "should create addon group with display_mode"

## AC-WB003-04: AI 자연어 입력

- [x] AI 자연어 엔드포인트 존재 (POST /constraints/ai)
  - Route: admin/constraints.ts
- [x] 승인 엔드포인트 존재 (POST /constraints/ai/confirm)
  - Route: admin/constraints.ts, saves constraint + nl_history
- [ ] 실제 AI 모델 연동 — 백엔드 API stub 구현됨 (AI 모델은 별도 SPEC)

## AC-WB003-05: 규칙 테스트

- [x] 단일 규칙 테스트 엔드포인트 존재 (POST /constraints/test)
  - Covered by: constraint routes test
- [x] 전체 규칙 테스트 엔드포인트 존재
  - Body로 singleConstraintId 유무에 따라 분기

## AC-WB003-06: 복합 조건 (AND/OR)

- [x] extra_conditions JSONB 저장 가능
  - Schema: recipe_constraints.extra_conditions (jsonb nullable)
- [x] json-rules-engine에서 extra_conditions 평가
  - Covered by: ConstraintService.convertToRulesEngineFormat
  - Test: `src/__tests__/services/constraint.service.test.ts`

---

## Test Summary

| Test File | Tests | Status |
|-----------|-------|--------|
| routes/constraints.test.ts | 22 | PASS |
| routes/addonGroups.test.ts | 19 | PASS |
| routes/constraintEvaluate.test.ts | 7 | PASS |
| services/constraint.service.test.ts | 29 | PASS |
| **WB-003 Total** | **77** | **ALL PASS** |
| Full suite (15 files) | 256 | ALL PASS |

---

## MX Tag Verification

| File | Tag | Reason |
|------|-----|--------|
| `src/services/constraint.service.ts` | `@MX:ANCHOR evaluateConstraints` | fan_in >= 3 (widget evaluate, test endpoint, admin preview) |
| `src/services/constraint.service.ts` | `@MX:NOTE convertToRulesEngineFormat` | Business logic mapping DB ECA to json-rules-engine |
| `packages/db/src/schema/widget/03-recipe-constraints.ts` | `@MX:ANCHOR` | Core ECA table, fan_in >= 3 (constraint service, evaluate endpoint, admin routes, nl_history FK) |
| `packages/db/src/schema/widget/03-recipe-constraints.ts` | `@MX:NOTE trigger_values` | JSONB magic — array of trigger match values |
| `packages/db/src/schema/widget/03-recipe-constraints.ts` | `@MX:NOTE actions` | JSONB magic — ECA action array, minimum 1 required |

---

*Generated by manager-docs sync workflow — 2026-02-25*
