# SPEC-SHOPBY-006 구현 계획: 주문 처리 및 백오피스 연동

---

## 메타데이터

| 항목 | 값 |
|------|------|
| SPEC ID | SPEC-SHOPBY-006 |
| 단계 | Phase 2 - 핵심 연동 개발 |
| 일정 | Day 15-21 |
| 의존성 | SPEC-SHOPBY-004 (주문/결제), SPEC-SHOPBY-005 (파일 관리) |
| 산출물 | 주문 상태 관리 서비스, MES 브리지, 알림 시스템, 관리자 대시보드 |

---

## 마일스톤

### M1: 주문 상태 관리 및 폴링 시스템 (Day 15-17) - Priority Critical

**목표**: Shopby 주문 상태를 인쇄 제작 워크플로우에 맞게 관리하는 시스템 구축

**작업 목록**:
1. 주문 상태 관리 서비스 구현
   - OrderStatus 열거형 및 상태 전이 규칙 정의
   - Shopby 상태 ↔ 인쇄 상태 매핑 테이블
   - 상태 전이 검증 로직 (유효하지 않은 전이 차단)
2. 주문 폴링 시스템 구현
   - 1분 간격 Shopby Admin API 폴링 (GET /orders)
   - 새 주문 감지 및 내부 레코드 생성
   - optionInputs에서 인쇄 사양 추출 및 파싱
3. 인쇄 사양 뷰어 서비스
   - optionInputs JSON → 가독성 있는 형태 변환
   - 디자인 파일 다운로드 링크 생성
   - 특수 요청사항, 시안 확인 여부 표시
4. Shopby Admin API 클라이언트 (주문 관리)
   - 주문 조회, 상태 변경, 배송 정보 업데이트
   - 인증 토큰 관리 (Admin Token)
5. 내부 주문 데이터 모델 (Prisma)
   - 주문 레코드, 상태 이력, MES 연동 정보

**완료 기준**:
- 새 주문이 1분 이내에 감지됨
- 주문 상태가 8단계 워크플로우에 맞게 관리됨
- 인쇄 사양이 가독성 있게 표시됨

### M2: MES 연동 브리지 (Day 17-18) - Priority High

**목표**: 인쇄 사양 데이터를 MES 시스템에 전달하는 브리지 구현

**작업 목록**:
1. MES 브리지 서비스 구현
   - MesJobRequest 생성기 (주문 데이터 → MES 포맷 변환)
   - 제작 마감일 계산 (상품별 제작 기간 적용)
   - 우선순위 설정 (일반/긴급)
2. MES 통신 어댑터
   - REST API 어댑터 (기본)
   - 메시지 큐 어댑터 (Redis/RabbitMQ) - 선택
   - 파일 기반 어댑터 (CSV/XML 내보내기) - 레거시 호환
3. MES 콜백 핸들러
   - 제작 시작/완료/검수 상태 수신
   - Shopby 주문 상태 자동 업데이트
4. MES 연동 장애 대응
   - 전송 실패 시 재시도 큐
   - 연속 실패 시 관리자 알림

**의존성**: M1 (주문 상태 관리 시스템)

**완료 기준**:
- "제작대기" 상태 변경 시 MES에 자동 전달됨
- MES 콜백으로 주문 상태가 자동 업데이트됨
- MES 연동 장애 시 재시도 및 관리자 알림 동작

### M3: 클레임 처리 및 배송 설정 (Day 18-19) - Priority High

**목표**: 인쇄물 특성을 반영한 클레임/배송 처리 시스템

**작업 목록**:
1. 클레임 처리 서비스
   - 상태별 클레임 정책 적용 (전액환불/부분환불/재제작)
   - Shopby 클레임 API 연동 (POST /claims)
   - 환불 금액 계산 (수수료 적용)
   - 재제작 주문 생성 로직
2. 배송 설정 서비스
   - 상품별 제작 기간 설정 관리
   - Shopby delivery-template 연동
   - 배송비 계산 (기본 + 지역 추가)
   - 무료배송 조건 관리 (회원 등급별)
3. 운송장 등록
   - Shopby Admin API를 통한 운송장 번호 등록
   - 배송 추적 URL 생성
4. 클레임 이력 관리
   - 클레임 요청, 처리 과정, 결과 기록
   - 관리자 코멘트 기능

**의존성**: M1

**완료 기준**:
- 제작 전 주문 취소 시 전액 환불 처리됨
- 제작 후 불량 시 재제작 처리 워크플로우 동작
- 운송장 등록 후 "출고완료" 상태 변경됨

### M4: 알림 시스템 (Day 19-20) - Priority Medium

**목표**: 주문 상태 변경 시 고객 알림 (알림톡/이메일)

**작업 목록**:
1. 알림 서비스 기본 구조
   - 알림 채널 추상화 (알림톡, 이메일, SMS)
   - 알림 템플릿 관리 (5종 기본 템플릿)
   - 알림 발송 큐 (Bull Queue)
2. 카카오 알림톡 연동
   - 알림톡 API 클라이언트
   - 템플릿 변수 치환 (주문번호, 상품명, 운송장 등)
   - 발송 실패 재시도 (최대 3회)
3. 이메일 발송 연동
   - AWS SES 또는 SendGrid 클라이언트
   - HTML 이메일 템플릿
   - 이메일 폴백 (알림톡 실패 시)
4. 상태 변경 이벤트 → 알림 자동 발송
   - 상태 전이 규칙에 알림 트리거 연결
   - 알림 발송 이력 관리

**의존성**: M1 (주문 상태 변경 이벤트)

**완료 기준**:
- 5개 주요 시점에서 알림이 자동 발송됨
- 알림톡 실패 시 이메일 폴백 동작
- 알림 발송 이력이 관리됨

### M5: 관리자 대시보드 (Day 20-21) - Priority Low (Optional)

**목표**: 일별/월별 주문 현황 대시보드

**작업 목록**:
1. 대시보드 데이터 API
   - 일별/월별 주문 건수 및 금액 집계
   - 상태별 주문 현황 집계
   - 상품별 주문 통계
   - 클레임 현황 통계
2. 대시보드 프론트엔드 (간단한 관리자 페이지)
   - 주요 KPI 카드 (오늘 주문, 매출, 제작대기 등)
   - 상태별 주문 현황 차트
   - 최근 주문 목록
3. 데이터 새로고침 (1분 간격 자동 갱신)

**의존성**: M1, M2, M3

**완료 기준**:
- 관리자가 일별 주문 현황을 대시보드에서 확인 가능
- 상태별 주문 건수가 실시간 표시됨

---

## 기술적 접근

### Webhook 미지원 대응 전략

Shopby가 주문 이벤트 Webhook을 제공하지 않으므로:

1. **주기적 폴링**: 1분 간격으로 Shopby Admin API 주문 목록 조회
2. **변경 감지**: 마지막 조회 시점 이후 변경된 주문 식별
3. **이벤트 발행**: 내부 이벤트 시스템으로 상태 변경 이벤트 발행
4. **구독 처리**: MES 전달, 알림 발송 등 후속 처리

### 모듈 구조 (예상)

```
apps/api/src/
  services/
    order-status.service.ts        # 주문 상태 관리
    order-poller.service.ts        # 주문 폴링
    print-spec-viewer.service.ts   # 인쇄 사양 뷰어
    mes-bridge.service.ts          # MES 연동
    claim-handler.service.ts       # 클레임 처리
    delivery-config.service.ts     # 배송 설정
    notification.service.ts        # 알림 서비스
  adapters/
    mes-rest.adapter.ts            # MES REST API
    mes-queue.adapter.ts           # MES 메시지 큐
    kakao-alimtalk.adapter.ts      # 카카오 알림톡
    email-ses.adapter.ts           # AWS SES 이메일
  jobs/
    order-polling.job.ts           # 주문 폴링 스케줄러
    notification-queue.job.ts      # 알림 발송 큐

apps/admin/src/
  pages/
    dashboard/                     # 관리자 대시보드
    orders/                        # 주문 관리
    claims/                        # 클레임 관리
```

---

## 위험 및 대응

| 위험 | 대응 |
|---|---|
| 폴링 방식의 주문 감지 지연 (최대 1분) | 실시간성이 필요한 경우 폴링 간격 단축 (30초) |
| MES 시스템 인터페이스 미확정 | 어댑터 패턴으로 교체 가능한 구조 |
| 알림톡 발신 프로필 미등록 | 사전 등록 요청 + 이메일 폴백 |
| Shopby Admin API 배송 관련 문서 불완전 | 실제 API 테스트로 검증 + 점진적 구현 |
| 대시보드 성능 (대량 데이터 집계) | 집계 데이터 캐싱 + 비동기 갱신 |

---

문서 버전: 1.0.0
