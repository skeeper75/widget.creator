# SPEC-SHOPBY-006 수용 기준: 주문 처리 및 백오피스 연동

---

## 메타데이터

| 항목 | 값 |
|------|------|
| SPEC ID | SPEC-SHOPBY-006 |
| 검증 방법 | 단위 테스트, 통합 테스트, E2E 주문 처리 테스트 |
| 품질 기준 | 테스트 커버리지 85% 이상, 주문 상태 전이 전체 경로 검증 |

---

## 수용 시나리오

### AC-001: 주문 상태 워크플로우 (R-ADM-001)

```gherkin
Feature: 인쇄 주문 상태 워크플로우 관리

  Scenario: 정상 주문 처리 전체 흐름
    Given 결제가 완료된 인쇄 주문이 존재할 때
    When 주문 상태를 순차적으로 전이시키면
    Then 결제완료 → 주문확인 → 제작대기 → 제작중 → 검수완료 → 출고준비 → 출고완료 → 배송완료 순서로 진행된다
    And 각 전이 시 Shopby Admin API의 주문 상태도 동기화된다

  Scenario: 유효하지 않은 상태 전이 차단
    Given 주문 상태가 "제작중"일 때
    When "결제완료" 상태로 변경을 시도하면
    Then "유효하지 않은 상태 전이입니다" 에러가 반환된다
    And 주문 상태가 변경되지 않는다

  Scenario: 새 주문 자동 감지
    Given Shopby에서 새로운 결제완료 주문이 생성되었을 때
    When 폴링 주기(1분)가 도래하면
    Then 새 주문이 내부 시스템에 자동 등록된다
    And optionInputs에서 인쇄 사양이 추출된다
```

### AC-002: 인쇄 사양 조회 (R-ADM-002)

```gherkin
Feature: 주문의 인쇄 사양 데이터 조회

  Scenario: 인쇄 사양 가독성 표시
    Given 관리자가 주문 상세를 조회할 때
    When 인쇄 사양 패널을 확인하면
    Then 다음 항목이 가독성 있게 표시된다:
      | 항목 | 예시 값 |
      | 상품명 | 명함 (일반명함) |
      | 규격 | 90 x 50 mm |
      | 용지 | 스노우화이트 250g |
      | 도수 | 양면컬러 (4/4) |
      | 수량 | 200매 |
      | 후가공 | 양면코팅 |
      | 인쇄방식 | 옵셋인쇄 |
    And 디자인 파일 다운로드 링크가 클릭 가능하다
    And 특수 요청사항이 표시된다

  Scenario: optionInputs 파싱 실패 대응
    Given optionInputs JSON 형식이 예상과 다를 때
    When 인쇄 사양을 파싱하면
    Then 파싱 실패 에러가 기록된다
    And 원본 JSON 데이터가 폴백으로 표시된다
    And 관리자에게 "인쇄 사양 파싱 오류" 알림이 발송된다
```

### AC-003: MES 시스템 연동 (R-ADM-003)

```gherkin
Feature: MES 시스템 제작 작업 등록

  Scenario: 제작대기 시 MES 자동 전달
    Given 주문 상태가 "주문확인"이고 디자인 파일이 확인되었을 때
    When 주문 상태를 "제작대기"로 변경하면
    Then MES 시스템에 MesJobRequest가 전달된다
    And 전달 데이터에 인쇄 사양, 디자인 파일 URL, 제작 마감일이 포함된다
    And MES mesJobId가 주문 레코드에 저장된다

  Scenario: MES 제작 완료 콜백
    Given MES에서 제작이 완료되었을 때
    When MES 콜백 (status: COMPLETED)이 수신되면
    Then 주문 상태가 자동으로 "검수완료"로 변경된다
    And Shopby 주문 상태도 동기화된다

  Scenario: MES 연동 실패 시 재시도
    Given MES 시스템이 일시적으로 응답하지 않을 때
    When 제작 작업 전달이 실패하면
    Then 재시도 큐에 등록된다 (최대 3회)
    And 3회 실패 시 관리자에게 알림이 발송된다
    And 주문 상태는 "제작대기"에서 변경되지 않는다
```

### AC-004: 클레임 처리 (R-ADM-004)

```gherkin
Feature: 인쇄 주문 클레임 처리

  Scenario: 제작 전 전액 취소
    Given 주문 상태가 "주문확인"일 때
    When 고객이 주문 취소를 요청하면
    Then 전액 환불 처리가 진행된다
    And Shopby 클레임 API를 통해 취소가 등록된다
    And 주문 상태가 "취소"로 변경된다

  Scenario: 제작대기 중 취소 (수수료 적용)
    Given 주문 상태가 "제작대기"일 때
    When 고객이 주문 취소를 요청하면
    Then 10% 수수료를 공제한 금액이 환불된다
    And 환불 금액 = 주문 금액 x 90%

  Scenario: 제작 중 취소 불가
    Given 주문 상태가 "제작중"일 때
    When 고객이 주문 취소를 요청하면
    Then "제작이 시작된 주문은 취소할 수 없습니다" 메시지가 반환된다
    And 주문 상태가 유지된다

  Scenario: 제작 불량 재제작
    Given 배송된 인쇄물에 불량이 발견되었을 때
    When 관리자가 재제작 클레임을 처리하면
    Then 재제작 주문이 생성된다
    And 원래 주문의 인쇄 사양이 복사된다
    And 원래 주문에 클레임 이력이 기록된다
```

### AC-005: 배송 설정 (R-ADM-005)

```gherkin
Feature: 인쇄물 배송 설정

  Scenario: 명함 배송 기간 계산
    Given 명함 상품의 제작 기간이 1 영업일이고 배송 기간이 2 영업일일 때
    When 예상 배송일을 계산하면
    Then 주문일로부터 3 영업일 후가 예상 배송일이다

  Scenario: 배송비 계산
    Given 주문 금액이 30,000원이고 회원 등급이 "일반"이며 배송지가 서울일 때
    When 배송비를 계산하면
    Then 기본 배송비 3,000원이 적용된다

  Scenario: 무료배송 적용
    Given 주문 금액이 50,000원이고 회원 등급이 "골드"일 때
    And 골드 등급 무료배송 기준이 30,000원 이상일 때
    When 배송비를 계산하면
    Then 배송비가 0원이다

  Scenario: 운송장 등록
    Given 주문 상태가 "출고준비"이고 포장이 완료되었을 때
    When 운송장 번호를 등록하면
    Then Shopby Admin API에 운송장 정보가 업데이트된다
    And 주문 상태가 "출고완료"로 변경된다
    And 고객에게 출고 알림이 발송된다
```

### AC-006: 알림 시스템 (R-ADM-006)

```gherkin
Feature: 주문 상태 변경 알림

  Scenario: 주문 접수 알림
    Given 새 주문이 감지되어 "주문확인" 상태로 변경되었을 때
    When 알림 발송이 트리거되면
    Then 카카오 알림톡으로 "주문이 접수되었습니다" 메시지가 발송된다
    And 주문번호, 상품명, 예상 제작일이 포함된다

  Scenario: 출고 완료 알림
    Given 운송장이 등록되어 "출고완료" 상태로 변경되었을 때
    When 알림 발송이 트리거되면
    Then 알림톡과 이메일 모두 발송된다
    And 운송장번호와 배송 조회 링크가 포함된다

  Scenario: 알림톡 발송 실패 시 이메일 폴백
    Given 카카오 알림톡 발송이 실패했을 때
    When 재시도 3회 후에도 실패하면
    Then 이메일로 동일한 내용이 폴백 발송된다
    And 알림톡 발송 실패가 로그에 기록된다
```

### AC-007: 주문 현황 대시보드 (R-ADM-007)

```gherkin
Feature: 관리자 주문 현황 대시보드

  Scenario: 일별 주문 현황 확인
    Given 관리자가 대시보드 페이지에 접속했을 때
    When 오늘 날짜의 현황을 확인하면
    Then 오늘 주문 건수, 매출 금액이 표시된다
    And 상태별 주문 건수 (제작대기 N건, 제작중 N건 등)가 표시된다

  Scenario: 대시보드 자동 갱신
    Given 관리자가 대시보드를 보고 있을 때
    When 1분이 경과하면
    Then 대시보드 데이터가 자동으로 갱신된다
    And 변경된 수치가 시각적으로 강조된다
```

---

## 완료 정의 (Definition of Done)

- [ ] 주문 상태 8단계 워크플로우가 정상 동작함
- [ ] 새 주문이 1분 이내에 자동 감지됨
- [ ] 인쇄 사양이 optionInputs에서 정확히 추출/표시됨
- [ ] "제작대기" 전이 시 MES에 자동 전달됨
- [ ] MES 콜백으로 주문 상태가 자동 업데이트됨
- [ ] 클레임 처리 (전액환불/부분환불/재제작) 정상 동작
- [ ] 운송장 등록 후 Shopby 배송 상태 동기화됨
- [ ] 5개 주요 시점 알림 발송 동작 (알림톡+이메일)
- [ ] 알림톡 실패 시 이메일 폴백 동작
- [ ] 관리자 대시보드에서 일별 주문 현황 확인 가능 (Optional)
- [ ] 테스트 커버리지 85% 이상

---

문서 버전: 1.0.0
