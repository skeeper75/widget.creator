# SPEC-SHOPBY-004 구현 계획: 주문 생성 및 결제 연동

---

## 메타데이터

| 항목 | 값 |
|------|------|
| SPEC ID | SPEC-SHOPBY-004 |
| 단계 | Phase 2 - 핵심 연동 개발 |
| 일정 | Day 8-14 (SPEC-SHOPBY-003과 병렬) |
| 의존성 | SPEC-SHOPBY-002 (상품 등록), SPEC-SHOPBY-003 (위젯 SDK) 부분 의존 |
| 산출물 | 주문 브리지, 가격 검증 서비스, 결제 연동 모듈 |

---

## 마일스톤

### M1: 주문서 생성 플로우 구현 (Day 8-10) - Priority Critical

**목표**: 위젯 → Shopby 주문서 생성 및 optionInputs 데이터 전달

**작업 목록**:
1. 주문서 생성 API 연동 (POST /order-sheets)
   - 즉시구매 요청 빌더 (productNo, optionNo, orderCnt)
   - 장바구니 기반 주문서 생성
2. optionInputs 빌더 구현
   - 인쇄 사양 JSON 직렬화기
   - 파일 URL 첨부
   - 특수 요청사항 및 시안 확인 플래그
3. 주문서 응답 핸들러
   - orderSheetNo 저장
   - 주문서 유효시간 관리
4. 회원/비회원 분기 처리
   - 회원: 기존 배송지 목록 조회 및 자동 입력
   - 비회원: 이름, 이메일, 전화번호 수집 폼

**완료 기준**:
- 위젯에서 즉시구매 시 주문서가 정상 생성됨
- optionInputs에 인쇄 사양 데이터가 정확히 포함됨
- 회원/비회원 양쪽 경로에서 주문서 생성 가능

### M2: 가격 검증 서비스 구현 (Day 10-11) - Priority Critical

**목표**: 위젯 가격과 Shopby 주문 가격의 일치 검증

**작업 목록**:
1. 가격 검증 모듈 구현
   - 위젯 가격 vs Shopby 계산 가격 비교
   - 허용 오차 규칙 (100원 이내, 100~1000원, 1000원 초과)
   - 검증 결과 액션 (PROCEED / WARN / BLOCK)
2. 주문서 금액 계산 API 연동 (POST /order-sheets/{id}/calculate)
   - 쿠폰 적용
   - 적립금 사용
   - 할인 계산
3. 서버 측 가격 재검증 API
   - Widget Creator API에서 가격 재계산
   - Shopby 주문 금액과 비교
4. 관리자 알림 (불일치 시)
   - 로그 기록
   - 알림 발송 (이메일/Slack)

**의존성**: M1 (주문서 생성 완료 후 금액 계산 가능)

**완료 기준**:
- 가격 검증이 3단계 (정상/경고/차단)로 동작
- 100원 이내 차이는 정상 처리
- 1000원 초과 차이는 주문 차단

### M3: 결제 연동 구현 (Day 11-13) - Priority High

**목표**: PG 결제 예약, 결제 SDK 호출, 결제 확인 프로세스 구현

**작업 목록**:
1. 결제 예약 API 연동 (POST /payments/reserve)
   - 결제 수단 선택 (신용카드, 계좌이체, 간편결제)
   - 결제 금액 전달
   - 결제 예약 응답 처리
2. PG 결제 SDK 연동
   - Shopby 제공 결제 SDK 초기화
   - PG 결제 페이지 호출 (팝업/리다이렉트)
   - 결제 결과 콜백 처리
3. 결제 확인 처리 (POST /payments/confirm)
   - PG 승인 결과 전달
   - 주문 상태 확인 ("결제완료")
4. 에러 핸들링
   - PG 결제 실패 시 재결제 안내
   - 타임아웃 처리
   - 네트워크 에러 복구

**의존성**: M1, M2

**완료 기준**:
- 신용카드 결제가 Sandbox 환경에서 정상 동작
- 간편결제(카카오페이/네이버페이) 연동 확인
- 결제 실패 시 에러 메시지 및 재시도 UI 제공

### M4: 통합 테스트 및 검증 (Day 13-14) - Priority High

**목표**: 전체 주문-결제 플로우 E2E 테스트

**작업 목록**:
1. E2E 주문 플로우 테스트
   - 위젯 옵션 선택 → 주문서 생성 → 금액 계산 → 결제 → 완료
   - 즉시구매 플로우
   - 장바구니 → 주문 플로우
2. 가격 일치 검증 테스트
   - 정상 케이스 (차이 0원)
   - 경계 케이스 (차이 100원)
   - 차단 케이스 (차이 1000원 초과)
3. 에러 시나리오 테스트
   - PG 결제 실패
   - 주문서 만료
   - 네트워크 에러
4. 회원/비회원 양쪽 주문 플로우 검증

**의존성**: M1, M2, M3

**완료 기준**:
- 위젯에서 선택한 옵션으로 Shopby 주문이 정상 생성됨
- 결제 완료 후 주문 상태가 "결제완료"로 변경됨
- 에러 시나리오에서 적절한 안내 메시지 제공

---

## 기술적 접근

### 가격 검증 전략

Widget Creator 가격 엔진의 동적 가격과 Shopby의 정적 옵션 가격 사이의 불가피한 차이를 관리:

1. **등록 시**: 옵션 조합별 addPrice를 가격 엔진 결과로 설정
2. **주문 시**: 위젯 가격을 optionInputs에 포함하여 서버 측 검증 기준으로 활용
3. **검증**: Shopby 계산 금액 vs 위젯 계산 금액 비교
4. **보정**: 가격 변동 시 정기 배치로 Shopby 옵션 가격 업데이트

### 결제 보안

- PG 결제 금액 위변조 방지: 서버 측 금액 검증
- 결제 예약 시 금액 서명 (Shopby 기본 제공)
- CSRF 토큰 적용
- 결제 결과 서버 간 검증 (Server-to-Server)

---

## 위험 및 대응

| 위험 | 대응 |
|---|---|
| 위젯 가격과 Shopby 가격 불일치 빈번 | 가격 동기화 배치 주기 단축 + 실시간 모니터링 |
| PG 결제 SDK 호환성 이슈 | 다수 PG사 대응으로 폴백 확보 |
| 주문서 만료로 결제 실패 | 주문서 유효시간 안내 + 자동 재생성 |
| optionInputs 데이터 길이 제한 | 핵심 데이터만 포함, 상세 데이터는 별도 API 참조 |

---

문서 버전: 1.0.0
