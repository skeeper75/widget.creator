// Prisma schema for Widget Creator - Print Knowledge Database
// Implements SPEC-DATA-001 section 4.1

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

generator client {
  provider = "prisma-client-js"
}

// ============================================================
// ProductCategory: Hierarchical product categories (max 3 levels)
// TAG-DB-SCHEMA: R-DB-001
// ============================================================
model ProductCategory {
  id           String  @id @default(cuid())
  slug         String  @unique
  displayName  String
  parentId     String?
  level        Int
  productCount Int     @default(0)
  keywords     String[]
  sortOrder    Int     @default(0)

  parent   ProductCategory?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children ProductCategory[] @relation("CategoryHierarchy")

  products PrintProduct[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([parentId])
  @@index([level])
}

// ============================================================
// PrintProduct: Master product record
// TAG-DB-SCHEMA: R-DB-002
// ============================================================
model PrintProduct {
  id                String  @id @default(cuid())
  externalId        Int     @unique
  name              String
  categoryId        String
  selType           String
  pjoin             Int     @default(0)
  unit              String
  fileTypes         String[]
  coverInfo         Json
  deliveryGroupNo   Int?
  deliveryGroupName String?
  deliveryPrepay    Boolean @default(false)
  cutoffTime        String?
  syncedAt          DateTime
  rawData           Json

  category ProductCategory @relation(fields: [categoryId], references: [id])

  sizes         ProductSize[]
  papers        ProductPaper[]
  colors        ProductColor[]
  printMethods  ProductPrintMethod[]
  postProcesses ProductPostProcess[]
  orderQtys     ProductOrderQty[]
  pricingTables PricingTable[]
  deliveryInfo  DeliveryInfo?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([externalId])
}

// ============================================================
// ProductSize: Size specification per cover type
// TAG-DB-SCHEMA: R-DB-002, R-DB-003
// ============================================================
model ProductSize {
  id              String  @id @default(cuid())
  productId       String
  externalSizeNo  Int
  coverCd         Int
  sizeName        String
  width           Int
  height          Int
  cutSize         Int
  isNonStandard   Boolean @default(false)
  reqWidth        Json?
  reqHeight       Json?
  reqAwkjob       Json?
  rstOrdqty       Json?
  rstAwkjob       Json?

  product PrintProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId, coverCd])
  @@index([externalSizeNo])
}

// ============================================================
// ProductPaper: Paper specification per cover type
// TAG-DB-SCHEMA: R-DB-002, R-DB-003
// ============================================================
model ProductPaper {
  id              String  @id @default(cuid())
  productId       String
  externalPaperNo Int
  coverCd         Int
  paperName       String
  paperGroup      String
  pGram           Int?
  reqWidth        Json?
  reqHeight       Json?
  reqAwkjob       Json?
  rstOrdqty       Json?
  rstPrsjob       Json?
  rstAwkjob       Json?

  product PrintProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId, coverCd])
  @@index([externalPaperNo])
}

// ============================================================
// ProductColor: Color specification per cover/page type
// TAG-DB-SCHEMA: R-DB-002, R-DB-003
// ============================================================
model ProductColor {
  id               String  @id @default(cuid())
  productId        String
  externalColorNo  Int
  coverCd          Int
  pageCd           Int
  colorName        String
  pdfPage          Int
  isAdditional     Boolean @default(false)
  reqPrsjob        Json?
  reqAwkjob        Json?
  rstPrsjob        Json?
  rstAwkjob        Json?

  product PrintProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId, coverCd, pageCd])
  @@index([externalColorNo])
}

// ============================================================
// ProductPrintMethod: Print job preset configuration
// TAG-DB-SCHEMA: R-DB-002, R-DB-003
// ============================================================
model ProductPrintMethod {
  id                   String @id @default(cuid())
  productId            String
  externalJobPresetNo  Int
  jobPreset            String
  prsjobList           Json
  reqColor             Json?
  rstPaper             Json?
  rstAwkjob            Json?

  product PrintProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([externalJobPresetNo])
}

// ============================================================
// ProductPostProcess: Post-processing (awkjob) configuration
// TAG-DB-SCHEMA: R-DB-002, R-DB-003
// ============================================================
model ProductPostProcess {
  id           String @id @default(cuid())
  productId    String
  coverCd      Int
  inputType    String
  jobGroupList Json

  product PrintProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId, coverCd])
}

// ============================================================
// ProductOrderQty: Order quantity configuration
// TAG-DB-SCHEMA: R-DB-002
// ============================================================
model ProductOrderQty {
  id          String   @id @default(cuid())
  productId   String
  displayType String
  jobPresetNo Int?
  sizeNo      Int?
  paperNo     Int?
  optNo       Int?
  colorNo     Int?
  colorNoAdd  Int?
  minQty      Decimal
  maxQty      Decimal
  interval    Decimal?
  qtyList     Decimal[]

  product PrintProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId, jobPresetNo, sizeNo, paperNo, optNo, colorNo, colorNoAdd])
}

// ============================================================
// PricingTable: Price lookup table
// TAG-DB-SCHEMA: R-PRC-001, R-PRC-002
// ============================================================
model PricingTable {
  id          String  @id @default(cuid())
  productId   String
  jobPresetNo Int?
  sizeNo      Int?
  paperNo     Int?
  colorNo     Int?
  colorNoAdd  Int?
  optNo       Int?
  quantity    Decimal
  unitPrice   Decimal
  totalPrice  Decimal

  product PrintProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId, jobPresetNo, sizeNo, paperNo, colorNo, colorNoAdd, optNo, quantity])
}

// ============================================================
// DeliveryInfo: Delivery configuration per product
// TAG-DB-SCHEMA: R-DB-002
// ============================================================
model DeliveryInfo {
  id           String @id @default(cuid())
  productId    String @unique
  freeShipping Json
  methods      Json
  regions      Json

  product PrintProduct @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================
// SPEC-DATA-002: Print Auto-Quote Data Normalization
// 26 new models for Huni print auto-quote system
// ============================================================

// ------------------------------------------------------------
// Domain 1: Product Catalog
// ------------------------------------------------------------

// HuniCategory: Hierarchical product categories
model HuniCategory {
  id           Int      @id @default(autoincrement())
  code         String   @unique @db.VarChar(50)
  name         String   @db.VarChar(100)
  parentId     Int?
  depth        Int      @default(0) @db.SmallInt
  displayOrder Int      @default(0) @db.SmallInt
  iconUrl      String?  @db.VarChar(500)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.Timestamptz()
  updatedAt    DateTime @updatedAt @db.Timestamptz()

  parent   HuniCategory?  @relation("HuniCategoryHierarchy", fields: [parentId], references: [id])
  children HuniCategory[] @relation("HuniCategoryHierarchy")
  products HuniProduct[]

  @@index([parentId])
  @@map("categories")
}

// HuniProduct: Master product record for Huni system
model HuniProduct {
  id            Int      @id @default(autoincrement())
  categoryId    Int
  huniCode      String   @unique @db.VarChar(10)
  edicusCode    String?  @unique @db.VarChar(15)
  shopbyId      Int?     @unique
  name          String   @db.VarChar(200)
  slug          String   @unique @db.VarChar(200)
  productType   String   @db.VarChar(30)
  pricingModel  String   @db.VarChar(30)
  sheetStandard String?  @db.VarChar(5)
  figmaSection  String?  @db.VarChar(50)
  orderMethod   String   @default("upload") @db.VarChar(20)
  editorEnabled Boolean  @default(false)
  description   String?  @db.Text
  isActive      Boolean  @default(true)
  mesRegistered Boolean  @default(true)
  createdAt     DateTime @default(now()) @db.Timestamptz()
  updatedAt     DateTime @updatedAt @db.Timestamptz()

  category       HuniCategory            @relation(fields: [categoryId], references: [id])
  sizes          HuniProductSize[]
  productOptions HuniProductOption[]
  fixedPrices    HuniFixedPrice[]
  packagePrices  HuniPackagePrice[]
  paperMappings  HuniPaperProductMapping[]
  mesMappings    HuniProductMesMapping[]
  editorMapping  HuniProductEditorMapping?
  constraints    HuniOptionConstraint[]
  dependencies   HuniOptionDependency[]

  @@index([categoryId])
  @@index([productType])
  @@index([pricingModel])
  @@map("products")
}

// HuniProductSize: Size specifications per product
// Note: @@map("product_sizes") - conflicts with existing ProductSize model name only, not SQL table
model HuniProductSize {
  id              Int      @id @default(autoincrement())
  productId       Int
  code            String   @db.VarChar(50)
  displayName     String   @db.VarChar(100)
  cutWidth        Decimal? @db.Decimal(8, 2)
  cutHeight       Decimal? @db.Decimal(8, 2)
  workWidth       Decimal? @db.Decimal(8, 2)
  workHeight      Decimal? @db.Decimal(8, 2)
  bleed           Decimal? @default(3.0) @db.Decimal(5, 2)
  impositionCount Int?     @db.SmallInt
  sheetStandard   String?  @db.VarChar(5)
  displayOrder    Int      @default(0) @db.SmallInt
  isCustom        Boolean  @default(false)
  customMinW      Decimal? @db.Decimal(8, 2)
  customMinH      Decimal? @db.Decimal(8, 2)
  customMaxW      Decimal? @db.Decimal(8, 2)
  customMaxH      Decimal? @db.Decimal(8, 2)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now()) @db.Timestamptz()
  updatedAt       DateTime @updatedAt @db.Timestamptz()

  product       HuniProduct      @relation(fields: [productId], references: [id])
  fixedPrices   HuniFixedPrice[]
  packagePrices HuniPackagePrice[]

  @@unique([productId, code])
  @@index([productId])
  @@map("product_sizes")
}

// ------------------------------------------------------------
// Domain 2: Materials
// ------------------------------------------------------------

// HuniPaper: Paper specifications
model HuniPaper {
  id             Int      @id @default(autoincrement())
  code           String   @unique @db.VarChar(50)
  name           String   @db.VarChar(100)
  abbreviation   String?  @db.VarChar(20)
  weight         Int?     @db.SmallInt
  sheetSize      String?  @db.VarChar(50)
  costPerRear    Decimal? @db.Decimal(12, 2)
  sellingPerRear Decimal? @db.Decimal(12, 2)
  costPer4Cut    Decimal? @db.Decimal(10, 2)
  sellingPer4Cut Decimal? @db.Decimal(10, 2)
  displayOrder   Int      @default(0) @db.SmallInt
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @db.Timestamptz()
  updatedAt      DateTime @updatedAt @db.Timestamptz()

  productMappings HuniPaperProductMapping[]
  optionChoices   HuniOptionChoice[]
  fixedPrices     HuniFixedPrice[]

  @@index([weight])
  @@map("papers")
}

// HuniMaterial: Non-paper material specifications
model HuniMaterial {
  id           Int      @id @default(autoincrement())
  code         String   @unique @db.VarChar(50)
  name         String   @db.VarChar(100)
  materialType String   @db.VarChar(30)
  thickness    String?  @db.VarChar(20)
  description  String?  @db.Text
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.Timestamptz()
  updatedAt    DateTime @updatedAt @db.Timestamptz()

  optionChoices HuniOptionChoice[]
  fixedPrices   HuniFixedPrice[]

  @@index([materialType])
  @@map("materials")
}

// HuniPaperProductMapping: Paper-to-product associations
model HuniPaperProductMapping {
  id        Int      @id @default(autoincrement())
  paperId   Int
  productId Int
  coverType String?  @db.VarChar(10)
  isDefault Boolean  @default(false)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  paper   HuniPaper   @relation(fields: [paperId], references: [id])
  product HuniProduct @relation(fields: [productId], references: [id])

  @@unique([paperId, productId, coverType])
  @@map("paper_product_mapping")
}

// ------------------------------------------------------------
// Domain 3: Processes
// ------------------------------------------------------------

// HuniPrintMode: Print mode specifications
model HuniPrintMode {
  id           Int      @id @default(autoincrement())
  code         String   @unique @db.VarChar(50)
  name         String   @db.VarChar(100)
  sides        String   @db.VarChar(10)
  colorType    String   @db.VarChar(20)
  priceCode    Int      @db.SmallInt
  displayOrder Int      @default(0) @db.SmallInt
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.Timestamptz()
  updatedAt    DateTime @updatedAt @db.Timestamptz()

  optionChoices HuniOptionChoice[]
  fixedPrices   HuniFixedPrice[]
  packagePrices HuniPackagePrice[]

  @@index([priceCode])
  @@map("print_modes")
}

// HuniPostProcess: Post-processing specifications
model HuniPostProcess {
  id            Int      @id @default(autoincrement())
  groupCode     String   @db.VarChar(20)
  code          String   @unique @db.VarChar(50)
  name          String   @db.VarChar(100)
  processType   String   @db.VarChar(30)
  subOptionCode Int?     @db.SmallInt
  subOptionName String?  @db.VarChar(50)
  priceBasis    String   @default("per_unit") @db.VarChar(15)
  sheetStandard String?  @db.VarChar(5)
  displayOrder  Int      @default(0) @db.SmallInt
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now()) @db.Timestamptz()
  updatedAt     DateTime @updatedAt @db.Timestamptz()

  optionChoices HuniOptionChoice[]

  @@index([groupCode])
  @@index([processType])
  @@map("post_processes")
}

// HuniBinding: Binding specifications for booklets
model HuniBinding {
  id           Int      @id @default(autoincrement())
  code         String   @unique @db.VarChar(50)
  name         String   @db.VarChar(50)
  minPages     Int?     @db.SmallInt
  maxPages     Int?     @db.SmallInt
  pageStep     Int?     @db.SmallInt
  displayOrder Int      @default(0) @db.SmallInt
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.Timestamptz()
  updatedAt    DateTime @updatedAt @db.Timestamptz()

  optionChoices HuniOptionChoice[]

  @@map("bindings")
}

// ------------------------------------------------------------
// Domain 4: Pricing
// ------------------------------------------------------------

// HuniPriceTable: Price table header
model HuniPriceTable {
  id            Int      @id @default(autoincrement())
  code          String   @unique @db.VarChar(50)
  name          String   @db.VarChar(100)
  priceType     String   @db.VarChar(10)
  quantityBasis String   @db.VarChar(20)
  sheetStandard String?  @db.VarChar(5)
  description   String?  @db.Text
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now()) @db.Timestamptz()
  updatedAt     DateTime @updatedAt @db.Timestamptz()

  tiers HuniPriceTier[]

  @@index([priceType])
  @@index([sheetStandard])
  @@map("price_tables")
}

// HuniPriceTier: Price tier entries per table
model HuniPriceTier {
  id           Int      @id @default(autoincrement())
  priceTableId Int
  optionCode   String   @db.VarChar(50)
  minQty       Int
  maxQty       Int      @default(999999)
  unitPrice    Decimal  @db.Decimal(12, 2)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.Timestamptz()
  updatedAt    DateTime @updatedAt @db.Timestamptz()

  priceTable HuniPriceTable @relation(fields: [priceTableId], references: [id])

  @@index([priceTableId])
  @@index([optionCode])
  @@index([priceTableId, optionCode, minQty])
  @@map("price_tiers")
}

// HuniFixedPrice: Fixed unit prices for specific product configurations
model HuniFixedPrice {
  id           Int      @id @default(autoincrement())
  productId    Int
  sizeId       Int?
  paperId      Int?
  materialId   Int?
  printModeId  Int?
  optionLabel  String?  @db.VarChar(100)
  baseQty      Int      @default(1)
  sellingPrice Decimal  @db.Decimal(12, 2)
  costPrice    Decimal? @db.Decimal(12, 2)
  vatIncluded  Boolean  @default(false)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.Timestamptz()
  updatedAt    DateTime @updatedAt @db.Timestamptz()

  product   HuniProduct      @relation(fields: [productId], references: [id])
  size      HuniProductSize? @relation(fields: [sizeId], references: [id])
  paper     HuniPaper?       @relation(fields: [paperId], references: [id])
  material  HuniMaterial?    @relation(fields: [materialId], references: [id])
  printMode HuniPrintMode?   @relation(fields: [printModeId], references: [id])

  @@index([productId])
  @@index([sizeId])
  @@index([productId, sizeId, paperId, printModeId])
  @@map("fixed_prices")
}

// HuniPackagePrice: Package-based pricing for booklets
model HuniPackagePrice {
  id           Int      @id @default(autoincrement())
  productId    Int
  sizeId       Int
  printModeId  Int
  pageCount    Int      @db.SmallInt
  minQty       Int
  maxQty       Int      @default(999999)
  sellingPrice Decimal  @db.Decimal(12, 2)
  costPrice    Decimal? @db.Decimal(12, 2)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.Timestamptz()
  updatedAt    DateTime @updatedAt @db.Timestamptz()

  product   HuniProduct     @relation(fields: [productId], references: [id])
  size      HuniProductSize @relation(fields: [sizeId], references: [id])
  printMode HuniPrintMode   @relation(fields: [printModeId], references: [id])

  @@index([productId])
  @@index([productId, sizeId, printModeId, pageCount, minQty])
  @@map("package_prices")
}

// HuniFoilPrice: Foil stamping price table
model HuniFoilPrice {
  id                Int      @id @default(autoincrement())
  foilType          String   @db.VarChar(30)
  foilColor         String?  @db.VarChar(30)
  plateMaterial     String?  @db.VarChar(20)
  targetProductType String?  @db.VarChar(30)
  width             Decimal  @db.Decimal(8, 2)
  height            Decimal  @db.Decimal(8, 2)
  sellingPrice      Decimal  @db.Decimal(12, 2)
  costPrice         Decimal? @db.Decimal(12, 2)
  displayOrder      Int      @default(0) @db.SmallInt
  isActive          Boolean  @default(true)
  createdAt         DateTime @default(now()) @db.Timestamptz()
  updatedAt         DateTime @updatedAt @db.Timestamptz()

  @@index([foilType])
  @@index([foilType, width, height])
  @@index([targetProductType])
  @@map("foil_prices")
}

// HuniImpositionRule: Sheet imposition calculation rules
model HuniImpositionRule {
  id              Int      @id @default(autoincrement())
  cutSizeCode     String   @db.VarChar(30)
  cutWidth        Decimal  @db.Decimal(8, 2)
  cutHeight       Decimal  @db.Decimal(8, 2)
  workWidth       Decimal  @db.Decimal(8, 2)
  workHeight      Decimal  @db.Decimal(8, 2)
  impositionCount Int      @db.SmallInt
  sheetStandard   String   @db.VarChar(5)
  description     String?  @db.VarChar(200)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now()) @db.Timestamptz()
  updatedAt       DateTime @updatedAt @db.Timestamptz()

  @@unique([cutWidth, cutHeight, sheetStandard])
  @@index([sheetStandard])
  @@map("imposition_rules")
}

// HuniLossQuantityConfig: Production loss rate configuration
model HuniLossQuantityConfig {
  id          Int      @id @default(autoincrement())
  scopeType   String   @db.VarChar(20)
  scopeId     Int?
  lossRate    Decimal  @db.Decimal(5, 4)
  minLossQty  Int      @default(0)
  description String?  @db.VarChar(200)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now()) @db.Timestamptz()
  updatedAt   DateTime @updatedAt @db.Timestamptz()

  @@unique([scopeType, scopeId])
  @@index([scopeType])
  @@map("loss_quantity_config")
}

// ------------------------------------------------------------
// Domain 5: Options & UI
// ------------------------------------------------------------

// HuniOptionDefinition: Master option type definitions
model HuniOptionDefinition {
  id           Int      @id @default(autoincrement())
  key          String   @unique @db.VarChar(50)
  name         String   @db.VarChar(100)
  optionClass  String   @db.VarChar(20)
  optionType   String   @db.VarChar(30)
  uiComponent  String   @db.VarChar(30)
  description  String?  @db.VarChar(500)
  displayOrder Int      @default(0) @db.SmallInt
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.Timestamptz()
  updatedAt    DateTime @updatedAt @db.Timestamptz()

  productOptions    HuniProductOption[]
  choices           HuniOptionChoice[]
  constraintsSource HuniOptionConstraint[] @relation("ConstraintSourceOption")
  constraintsTarget HuniOptionConstraint[] @relation("ConstraintTargetOption")
  dependenciesParent HuniOptionDependency[] @relation("DependencyParentOption")
  dependenciesChild  HuniOptionDependency[] @relation("DependencyChildOption")

  @@index([optionClass])
  @@map("option_definitions")
}

// HuniProductOption: Product-specific option configurations
model HuniProductOption {
  id                  Int      @id @default(autoincrement())
  productId           Int
  optionDefinitionId  Int
  displayOrder        Int      @default(0) @db.SmallInt
  isRequired          Boolean  @default(false)
  isVisible           Boolean  @default(true)
  isInternal          Boolean  @default(false)
  uiComponentOverride String?  @db.VarChar(30)
  defaultChoiceId     Int?
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now()) @db.Timestamptz()
  updatedAt           DateTime @updatedAt @db.Timestamptz()

  product          HuniProduct          @relation(fields: [productId], references: [id])
  optionDefinition HuniOptionDefinition @relation(fields: [optionDefinitionId], references: [id])
  defaultChoice    HuniOptionChoice?    @relation("ProductOptionDefaultChoice", fields: [defaultChoiceId], references: [id])

  @@unique([productId, optionDefinitionId])
  @@index([productId])
  @@index([productId, isVisible, displayOrder])
  @@map("product_options")
}

// HuniOptionChoice: Available choices per option definition
model HuniOptionChoice {
  id                  Int      @id @default(autoincrement())
  optionDefinitionId  Int
  code                String   @db.VarChar(50)
  name                String   @db.VarChar(100)
  priceKey            String?  @db.VarChar(50)
  refPaperId          Int?
  refMaterialId       Int?
  refPrintModeId      Int?
  refPostProcessId    Int?
  refBindingId        Int?
  displayOrder        Int      @default(0) @db.SmallInt
  isActive            Boolean  @default(true)
  createdAt           DateTime @default(now()) @db.Timestamptz()
  updatedAt           DateTime @updatedAt @db.Timestamptz()

  optionDefinition       HuniOptionDefinition     @relation(fields: [optionDefinitionId], references: [id])
  refPaper               HuniPaper?               @relation(fields: [refPaperId], references: [id])
  refMaterial            HuniMaterial?            @relation(fields: [refMaterialId], references: [id])
  refPrintMode           HuniPrintMode?           @relation(fields: [refPrintModeId], references: [id])
  refPostProcess         HuniPostProcess?         @relation(fields: [refPostProcessId], references: [id])
  refBinding             HuniBinding?             @relation(fields: [refBindingId], references: [id])
  productOptionsDefault  HuniProductOption[]      @relation("ProductOptionDefaultChoice")
  mesMappings            HuniOptionChoiceMesMapping[]
  dependenciesParent     HuniOptionDependency[]   @relation("DependencyParentChoice")

  @@unique([optionDefinitionId, code])
  @@index([optionDefinitionId])
  @@index([priceKey])
  @@index([refPaperId])
  @@index([refPrintModeId])
  @@map("option_choices")
}

// HuniOptionConstraint: UI visibility and value constraints per product
model HuniOptionConstraint {
  id             Int      @id @default(autoincrement())
  productId      Int
  constraintType String   @db.VarChar(20)
  sourceOptionId Int?
  sourceField    String   @db.VarChar(50)
  operator       String   @db.VarChar(10)
  value          String?  @db.VarChar(200)
  valueMin       String?  @db.VarChar(100)
  valueMax       String?  @db.VarChar(100)
  targetOptionId Int?
  targetField    String   @db.VarChar(50)
  targetAction   String   @db.VarChar(20)
  targetValue    String?  @db.VarChar(200)
  description    String?  @db.VarChar(500)
  priority       Int      @default(0) @db.SmallInt
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @db.Timestamptz()
  updatedAt      DateTime @updatedAt @db.Timestamptz()

  product      HuniProduct           @relation(fields: [productId], references: [id])
  sourceOption HuniOptionDefinition? @relation("ConstraintSourceOption", fields: [sourceOptionId], references: [id])
  targetOption HuniOptionDefinition? @relation("ConstraintTargetOption", fields: [targetOptionId], references: [id])

  @@index([productId])
  @@index([constraintType])
  @@index([sourceOptionId])
  @@index([targetOptionId])
  @@map("option_constraints")
}

// HuniOptionDependency: Parent-child option dependency rules
model HuniOptionDependency {
  id             Int      @id @default(autoincrement())
  productId      Int
  parentOptionId Int
  parentChoiceId Int?
  childOptionId  Int
  dependencyType String   @default("visibility") @db.VarChar(20)
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @db.Timestamptz()
  updatedAt      DateTime @updatedAt @db.Timestamptz()

  product      HuniProduct          @relation(fields: [productId], references: [id])
  parentOption HuniOptionDefinition @relation("DependencyParentOption", fields: [parentOptionId], references: [id])
  parentChoice HuniOptionChoice?    @relation("DependencyParentChoice", fields: [parentChoiceId], references: [id])
  childOption  HuniOptionDefinition @relation("DependencyChildOption", fields: [childOptionId], references: [id])

  @@index([productId])
  @@index([parentOptionId, parentChoiceId])
  @@index([childOptionId])
  @@map("option_dependencies")
}

// ------------------------------------------------------------
// Domain 6: Integration
// ------------------------------------------------------------

// HuniMesItem: MES system item master
model HuniMesItem {
  id           Int      @id @default(autoincrement())
  itemCode     String   @unique @db.VarChar(20)
  groupCode    String?  @db.VarChar(20)
  name         String   @db.VarChar(200)
  abbreviation String?  @db.VarChar(50)
  itemType     String   @db.VarChar(20)
  unit         String   @default("EA") @db.VarChar(10)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.Timestamptz()
  updatedAt    DateTime @updatedAt @db.Timestamptz()

  options         HuniMesItemOption[]
  productMappings HuniProductMesMapping[]
  choiceMappings  HuniOptionChoiceMesMapping[]

  @@index([groupCode])
  @@index([itemType])
  @@map("mes_items")
}

// HuniMesItemOption: MES item option values (up to 10 per item)
model HuniMesItemOption {
  id           Int      @id @default(autoincrement())
  mesItemId    Int
  optionNumber Int      @db.SmallInt
  optionValue  String?  @db.VarChar(200)
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @db.Timestamptz()
  updatedAt    DateTime @updatedAt @db.Timestamptz()

  mesItem HuniMesItem @relation(fields: [mesItemId], references: [id])

  @@unique([mesItemId, optionNumber])
  @@index([mesItemId])
  @@map("mes_item_options")
}

// HuniProductMesMapping: Product-to-MES item mapping
model HuniProductMesMapping {
  id        Int      @id @default(autoincrement())
  productId Int
  mesItemId Int
  coverType String?  @db.VarChar(10)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @db.Timestamptz()
  updatedAt DateTime @updatedAt @db.Timestamptz()

  product HuniProduct @relation(fields: [productId], references: [id])
  mesItem HuniMesItem @relation(fields: [mesItemId], references: [id])

  @@unique([productId, mesItemId, coverType])
  @@index([productId])
  @@index([mesItemId])
  @@map("product_mes_mapping")
}

// HuniProductEditorMapping: Product-to-editor (Edicus) 1:1 mapping
model HuniProductEditorMapping {
  id             Int      @id @default(autoincrement())
  productId      Int      @unique
  editorType     String   @default("edicus") @db.VarChar(30)
  templateId     String?  @db.VarChar(100)
  templateConfig Json?
  isActive       Boolean  @default(true)
  createdAt      DateTime @default(now()) @db.Timestamptz()
  updatedAt      DateTime @updatedAt @db.Timestamptz()

  product HuniProduct @relation(fields: [productId], references: [id])

  @@index([editorType])
  @@map("product_editor_mapping")
}

// HuniOptionChoiceMesMapping: Option choice to MES item mapping
model HuniOptionChoiceMesMapping {
  id             Int       @id @default(autoincrement())
  optionChoiceId Int
  mesItemId      Int?
  mesCode        String?   @db.VarChar(50)
  mappingType    String    @db.VarChar(20)
  mappingStatus  String    @default("pending") @db.VarChar(20)
  mappedBy       String?   @db.VarChar(100)
  mappedAt       DateTime? @db.Timestamptz()
  notes          String?   @db.Text
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now()) @db.Timestamptz()
  updatedAt      DateTime  @updatedAt @db.Timestamptz()

  optionChoice HuniOptionChoice @relation(fields: [optionChoiceId], references: [id])
  mesItem      HuniMesItem?     @relation(fields: [mesItemId], references: [id])

  @@unique([optionChoiceId, mappingType])
  @@index([optionChoiceId])
  @@index([mesItemId])
  @@index([mappingStatus])
  @@map("option_choice_mes_mapping")
}
